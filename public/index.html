<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Bookings - Hotel Booking System</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #f0f2f5;
      color: #333;
      min-height: 100vh;
    }

    .container {
      flex: 1;
      padding: 24px;
    }

    .card {
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.12);
      padding: 24px;
      margin-bottom: 24px;
    }

    .card h2 {
      font-size: 1.2rem;
      margin-bottom: 16px;
      color: #1a73e8;
    }

    .form-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
    }

    .form-group {
      display: flex;
      flex-direction: column;
    }

    .form-group label {
      font-size: 0.85rem;
      font-weight: 500;
      margin-bottom: 4px;
      color: #555;
    }

    .form-group input,
    .form-group select {
      padding: 10px 12px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 0.95rem;
      transition: border-color 0.2s;
    }

    .form-group input:focus,
    .form-group select:focus {
      outline: none;
      border-color: #1a73e8;
      box-shadow: 0 0 0 2px rgba(26,115,232,0.15);
    }

    .members-hint {
      font-size: 0.75rem;
      color: #888;
      margin-top: 3px;
    }

    .btn {
      padding: 10px 24px;
      border: none;
      border-radius: 6px;
      font-size: 0.95rem;
      font-weight: 500;
      cursor: pointer;
      transition: background 0.2s;
    }

    .btn-primary {
      background: #1a73e8;
      color: #fff;
      margin-top: 16px;
    }

    .btn-primary:hover { background: #1557b0; }

    .btn-danger {
      background: #dc3545;
      color: #fff;
      padding: 6px 14px;
      font-size: 0.85rem;
    }

    .btn-danger:hover { background: #b02a37; }

    .btn-view {
      background: #6c757d;
      color: #fff;
      padding: 6px 14px;
      font-size: 0.85rem;
      text-decoration: none;
      border-radius: 6px;
      display: inline-block;
    }

    .btn-view:hover { background: #565e64; }

    .btn-edit {
      background: #0d6efd;
      color: #fff;
      padding: 6px 14px;
      font-size: 0.85rem;
    }

    .btn-edit:hover { background: #0a58ca; }

    .action-btns {
      display: flex;
      gap: 6px;
    }

    .message {
      padding: 12px 16px;
      border-radius: 6px;
      margin-bottom: 16px;
      font-size: 0.9rem;
      display: none;
    }

    .message.success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }

    .message.error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }

    /* Pre-selected room info banner */
    .room-info-banner {
      display: none;
      padding: 14px 18px;
      background: #e8f0fe;
      border: 1px solid #c5d9f7;
      border-radius: 8px;
      margin-bottom: 16px;
      align-items: center;
      gap: 16px;
    }

    .room-info-banner.visible {
      display: flex;
    }

    .room-info-banner .rib-icon {
      font-size: 1.5rem;
    }

    .room-info-banner .rib-details {
      flex: 1;
    }

    .room-info-banner .rib-details strong {
      color: #1a73e8;
    }

    .room-info-banner .rib-details span {
      font-size: 0.88rem;
      color: #555;
    }

    .room-info-banner .rib-dismiss {
      background: none;
      border: none;
      color: #999;
      cursor: pointer;
      font-size: 1.2rem;
      padding: 4px;
    }

    .room-info-banner .rib-dismiss:hover {
      color: #333;
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    th, td {
      text-align: left;
      padding: 12px;
      border-bottom: 1px solid #eee;
    }

    th {
      background: #f8f9fa;
      font-size: 0.85rem;
      font-weight: 600;
      color: #555;
      text-transform: uppercase;
    }

    td { font-size: 0.9rem; }

    tr:hover { background: #f8f9fa; }

    .empty-state {
      text-align: center;
      padding: 40px;
      color: #999;
    }

    /* Edit Modal */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.5);
      z-index: 2000;
      align-items: center;
      justify-content: center;
    }

    .modal-overlay.open {
      display: flex;
    }

    .modal {
      background: #fff;
      border-radius: 12px;
      padding: 32px;
      width: 100%;
      max-width: 520px;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 8px 32px rgba(0,0,0,0.2);
    }

    .modal h2 {
      font-size: 1.2rem;
      color: #1a73e8;
      margin-bottom: 20px;
    }

    .modal-actions {
      display: flex;
      gap: 12px;
      margin-top: 16px;
    }

    .btn-secondary {
      background: #6c757d;
      color: #fff;
      padding: 10px 24px;
      border: none;
      border-radius: 6px;
      font-size: 0.95rem;
      font-weight: 500;
      cursor: pointer;
    }

    .btn-secondary:hover { background: #565e64; }

    @media (max-width: 600px) {
      .form-grid { grid-template-columns: 1fr; }
      .action-btns { flex-direction: column; }
    }
  </style>
</head>
<body>
  <div id="app-navbar"></div>

  <div class="main-content">
    <div class="container">
      <!-- Message Banner -->
      <div id="message" class="message"></div>

      <!-- Pre-selected Room Info -->
      <div class="room-info-banner" id="roomInfoBanner">
        <span class="rib-icon">&#127968;</span>
        <div class="rib-details">
          <strong id="ribRoomType"></strong><br>
          <span>Room <span id="ribRoomNumber"></span> &middot; <span id="ribPrice"></span>/night</span>
        </div>
        <button class="rib-dismiss" onclick="dismissRoomBanner()" title="Dismiss">&times;</button>
      </div>

      <!-- Booking Form -->
      <div class="card">
        <h2>New Booking</h2>
        <form id="bookingForm">
          <div class="form-grid">
            <div class="form-group">
              <label for="guestName">Guest Name</label>
              <input type="text" id="guestName" required placeholder="Full name">
            </div>
            <div class="form-group">
              <label for="guestPhone">Phone (10 digits)</label>
              <input type="tel" id="guestPhone" required pattern="\d{10}" maxlength="10" placeholder="0000000000">
            </div>
            <div class="form-group">
              <label for="roomNumber">Room</label>
              <select id="roomNumber" required>
                <option value="">Select Room</option>
                <option value="101">Room 101 - Standard</option>
                <option value="102">Room 102 - Deluxe</option>
                <option value="103">Room 103 - Suite</option>
                <option value="201">Room 201 - Family</option>
                <option value="202">Room 202 - Executive</option>
                <option value="203">Room 203 - Penthouse</option>
              </select>
            </div>
            <div class="form-group">
              <label for="members">Members</label>
              <select id="members" required>
                <option value="1">1</option>
                <option value="2">2</option>
                <option value="3">3</option>
                <option value="4">4</option>
                <option value="5">5</option>
              </select>
              <span class="members-hint" id="membersHint">Max capacity: 2</span>
            </div>
            <div class="form-group">
              <label for="checkIn">Check-In</label>
              <input type="date" id="checkIn" required>
            </div>
            <div class="form-group">
              <label for="checkOut">Check-Out</label>
              <input type="date" id="checkOut" required>
            </div>
          </div>
          <button type="submit" class="btn btn-primary">Book Room</button>
        </form>
      </div>

      <!-- Bookings Table -->
      <div class="card">
        <h2>Current Bookings</h2>
        <div id="bookingsContainer">
          <div class="empty-state">Loading bookings...</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Edit Booking Modal -->
  <div id="editModal" class="modal-overlay">
    <div class="modal">
      <h2>Edit Booking #<span id="editBookingId"></span></h2>
      <form id="editForm">
        <div class="form-grid">
          <div class="form-group">
            <label for="editGuestName">Guest Name</label>
            <input type="text" id="editGuestName" required placeholder="Full name">
          </div>
          <div class="form-group">
            <label for="editGuestPhone">Phone (10 digits)</label>
            <input type="tel" id="editGuestPhone" required pattern="\d{10}" maxlength="10" placeholder="0000000000">
          </div>
          <div class="form-group">
            <label for="editRoomNumber">Room</label>
            <select id="editRoomNumber" required>
              <option value="">Select Room</option>
              <option value="101">Room 101 - Standard</option>
              <option value="102">Room 102 - Deluxe</option>
              <option value="103">Room 103 - Suite</option>
              <option value="201">Room 201 - Family</option>
              <option value="202">Room 202 - Executive</option>
              <option value="203">Room 203 - Penthouse</option>
            </select>
          </div>
          <div class="form-group">
            <label for="editMembers">Members</label>
            <select id="editMembers" required>
              <option value="1">1</option>
              <option value="2">2</option>
              <option value="3">3</option>
              <option value="4">4</option>
              <option value="5">5</option>
            </select>
            <span class="members-hint" id="editMembersHint">Max capacity: 2</span>
          </div>
          <div class="form-group">
            <label for="editCheckIn">Check-In</label>
            <input type="date" id="editCheckIn" required>
          </div>
          <div class="form-group">
            <label for="editCheckOut">Check-Out</label>
            <input type="date" id="editCheckOut" required>
          </div>
        </div>
        <div class="modal-actions">
          <button type="submit" class="btn btn-primary" style="margin-top:0">Save Changes</button>
          <button type="button" class="btn btn-secondary" onclick="closeEditModal()">Cancel</button>
        </div>
      </form>
    </div>
  </div>

  <script src="/sitesh/app.js"></script>
  <script>
    if (!initAppPage('bookings')) throw new Error('Not authenticated');

    const API = BASE + '/api/bookings';
    const messageEl = document.getElementById('message');
    const form = document.getElementById('bookingForm');
    const container = document.getElementById('bookingsContainer');

    // Room capacity map
    const ROOM_CAPACITY = {
      '101': 2,
      '102': 3,
      '103': 4,
      '201': 5,
      '202': 3,
      '203': 4
    };

    // Update members dropdown options when room changes
    function updateMembersLimit(roomSelect, membersSelect, hintEl, autoSelect) {
      const room = roomSelect.value;
      const max = ROOM_CAPACITY[room] || 2;
      hintEl.textContent = room ? `Max capacity: ${max}` : 'Select a room first';

      // Enable/disable options based on capacity
      for (const opt of membersSelect.options) {
        const val = parseInt(opt.value);
        opt.disabled = val > max;
      }

      const currentVal = parseInt(membersSelect.value);
      // Auto-select room capacity when room changes (not during edit pre-population)
      if (autoSelect !== false) {
        membersSelect.value = max;
      } else if (currentVal > max) {
        membersSelect.value = max;
      }
    }

    document.getElementById('roomNumber').addEventListener('change', () => {
      updateMembersLimit(
        document.getElementById('roomNumber'),
        document.getElementById('members'),
        document.getElementById('membersHint'),
        true
      );
    });

    document.getElementById('editRoomNumber').addEventListener('change', () => {
      updateMembersLimit(
        document.getElementById('editRoomNumber'),
        document.getElementById('editMembers'),
        document.getElementById('editMembersHint'),
        true
      );
    });

    // Handle pre-selected room from "Book Now" on Rooms page
    (function handleRoomPreselect() {
      const params = new URLSearchParams(window.location.search);
      const roomNumber = params.get('roomNumber');
      const roomType = params.get('roomType');
      const price = params.get('price');

      if (roomNumber) {
        const roomSelect = document.getElementById('roomNumber');
        // Set the room dropdown value
        for (let opt of roomSelect.options) {
          if (opt.value === roomNumber) {
            opt.selected = true;
            break;
          }
        }

        // Update members limit for pre-selected room (auto-select capacity)
        updateMembersLimit(
          document.getElementById('roomNumber'),
          document.getElementById('members'),
          document.getElementById('membersHint'),
          true
        );

        // Show info banner
        if (roomType || price) {
          document.getElementById('ribRoomType').textContent = roomType || 'Room ' + roomNumber;
          document.getElementById('ribRoomNumber').textContent = roomNumber;
          document.getElementById('ribPrice').textContent = price ? '$' + price : '';
          document.getElementById('roomInfoBanner').classList.add('visible');
        }

        // Clean URL without reloading
        window.history.replaceState({}, '', window.location.pathname);
      }
    })();

    function dismissRoomBanner() {
      document.getElementById('roomInfoBanner').classList.remove('visible');
    }

    // Set minimum date to today
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('checkIn').min = today;
    document.getElementById('checkOut').min = today;

    // When check-in changes, set check-out min
    document.getElementById('checkIn').addEventListener('change', (e) => {
      document.getElementById('checkOut').min = e.target.value;
      const checkOut = document.getElementById('checkOut');
      if (checkOut.value && checkOut.value <= e.target.value) {
        checkOut.value = '';
      }
    });

    function showMessage(text, type) {
      showToast(text, type);
    }

    async function loadBookings() {
      try {
        const res = await fetch(API, { headers: Auth.headers() });

        if (res.status === 401 || res.status === 403) {
          Auth.logout();
          return;
        }

        const bookings = await res.json();

        if (bookings.length === 0) {
          container.innerHTML = '<div class="empty-state">No bookings yet. Create one above.</div>';
          return;
        }

        const rows = bookings.map(b => `
          <tr>
            <td>${b.id}</td>
            <td>${b.guest_name}</td>
            <td>${b.guest_phone}</td>
            <td>${b.room_number}</td>
            <td>${b.members || 1}</td>
            <td>${b.check_in_date}</td>
            <td>${b.check_out_date}</td>
            <td>
              <div class="action-btns">
                <a href="${BASE}/bookings/${b.id}" class="btn btn-view">View</a>
                <button class="btn btn-edit" onclick="openEditModal(${b.id})">Edit</button>
                <button class="btn btn-danger" onclick="deleteBooking(${b.id})">Delete</button>
              </div>
            </td>
          </tr>
        `).join('');

        container.innerHTML = `
          <table>
            <thead>
              <tr>
                <th>ID</th>
                <th>Guest</th>
                <th>Phone</th>
                <th>Room</th>
                <th>Members</th>
                <th>Check-In</th>
                <th>Check-Out</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>${rows}</tbody>
          </table>
        `;
      } catch {
        container.innerHTML = '<div class="empty-state">Failed to load bookings.</div>';
      }
    }

    form.addEventListener('submit', async (e) => {
      e.preventDefault();

      const roomNumber = document.getElementById('roomNumber').value;
      const membersEl = document.getElementById('members');
      const memberCount = parseInt(membersEl.value, 10) || 1;
      const maxCapacity = ROOM_CAPACITY[roomNumber] || 2;

      if (memberCount > maxCapacity) {
        showToast(`Members cannot exceed ${maxCapacity} for Room ${roomNumber}`, 'error');
        return;
      }

      const data = {
        guest_name: document.getElementById('guestName').value.trim(),
        guest_phone: document.getElementById('guestPhone').value.trim(),
        room_number: roomNumber,
        members: memberCount,
        check_in_date: document.getElementById('checkIn').value,
        check_out_date: document.getElementById('checkOut').value
      };

      try {
        const res = await fetch(API, {
          method: 'POST',
          headers: Auth.headers(),
          body: JSON.stringify(data)
        });

        const result = await res.json();

        if (res.status === 401 || res.status === 403) {
          Auth.logout();
          return;
        }

        if (!res.ok) {
          showToast(result.error, 'error');
          return;
        }

        showToast('Booking created successfully', 'success');
        form.reset();
        document.getElementById('members').value = '1';
        document.getElementById('membersHint').textContent = 'Select a room first';
        loadBookings();
      } catch {
        showToast('Failed to create booking. Please try again.', 'error');
      }
    });

    async function deleteBooking(id) {
      if (!confirm('Are you sure you want to delete this booking?')) return;

      try {
        const res = await fetch(`${API}/${id}`, {
          method: 'DELETE',
          headers: Auth.headers()
        });

        if (res.status === 401 || res.status === 403) {
          Auth.logout();
          return;
        }

        if (!res.ok) {
          const result = await res.json();
          showToast(result.error, 'error');
          return;
        }

        showToast('Booking deleted successfully', 'success');
        loadBookings();
      } catch {
        showToast('Failed to delete booking.', 'error');
      }
    }

    // ─── Edit Modal ─────────────────────────────────────────────
    let editingId = null;

    async function openEditModal(id) {
      try {
        const res = await fetch(`${API}/${id}`, { headers: Auth.headers() });
        if (!res.ok) {
          showToast('Failed to load booking details.', 'error');
          return;
        }
        const b = await res.json();
        editingId = b.id;
        document.getElementById('editBookingId').textContent = b.id;
        document.getElementById('editGuestName').value = b.guest_name;
        document.getElementById('editGuestPhone').value = b.guest_phone;
        document.getElementById('editRoomNumber').value = b.room_number;
        document.getElementById('editCheckIn').value = b.check_in_date;
        document.getElementById('editCheckOut').value = b.check_out_date;

        // Update members options for the selected room (don't auto-select)
        const editMembersSel = document.getElementById('editMembers');
        updateMembersLimit(
          document.getElementById('editRoomNumber'),
          editMembersSel,
          document.getElementById('editMembersHint'),
          false
        );

        // Pre-populate with existing member count (use String for select value matching)
        const savedMembers = String(b.members || 1);
        editMembersSel.value = savedMembers;
        // Fallback: if value didn't stick (e.g. option disabled), force it
        if (editMembersSel.value !== savedMembers) {
          editMembersSel.value = '1';
        }

        document.getElementById('editModal').classList.add('open');
      } catch {
        showToast('Failed to load booking details.', 'error');
      }
    }

    function closeEditModal() {
      document.getElementById('editModal').classList.remove('open');
      editingId = null;
    }

    // Close modal on overlay click
    document.getElementById('editModal').addEventListener('click', (e) => {
      if (e.target === e.currentTarget) closeEditModal();
    });

    document.getElementById('editForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      if (!editingId) return;

      const editRoom = document.getElementById('editRoomNumber').value;
      const editMembersVal = document.getElementById('editMembers');
      const editMemberCount = parseInt(editMembersVal.value, 10) || 1;
      const editMaxCapacity = ROOM_CAPACITY[editRoom] || 2;

      if (editMemberCount > editMaxCapacity) {
        showToast(`Members cannot exceed ${editMaxCapacity} for Room ${editRoom}`, 'error');
        return;
      }

      const data = {
        guest_name: document.getElementById('editGuestName').value.trim(),
        guest_phone: document.getElementById('editGuestPhone').value.trim(),
        room_number: editRoom,
        members: editMemberCount,
        check_in_date: document.getElementById('editCheckIn').value,
        check_out_date: document.getElementById('editCheckOut').value
      };

      try {
        const res = await fetch(`${API}/${editingId}`, {
          method: 'PUT',
          headers: Auth.headers(),
          body: JSON.stringify(data)
        });

        const result = await res.json();

        if (res.status === 401 || res.status === 403) {
          Auth.logout();
          return;
        }

        if (!res.ok) {
          showToast(result.error, 'error');
          return;
        }

        closeEditModal();
        showToast('Booking updated successfully', 'success');
        loadBookings();
      } catch {
        showToast('Failed to update booking.', 'error');
      }
    });

    // Initial load
    loadBookings();
  </script>
</body>
</html>
